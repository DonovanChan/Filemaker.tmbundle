<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>beforeRunningCommand</key>
	<string>nop</string>
	<key>command</key>
	<string>#!/usr/bin/ruby
#
# DESCRIPTION
#	Pretty prints FileMaker calculation
#
# TODO: Convert to hard tabs
# TODO: Iterate over text to deal with quoted strings properly
# TODO: Clean indentation (see FHTML.PL command)
# FIXME: Operators section clears entire input (test with json functions)
#

text = STDIN.read

# semi-colons
#text.gsub!(%r{(\n)[ \t]*;},';\1')
text.gsub!(%r{(//.*)?\n[ \t]*;},";\\1\n")
text.gsub!(/ *; */,' ; ')

# brackets
# 	Beware of altering quoted strings!
 text.gsub!(/ *\[ */,'[ ')
text.gsub!(/(\S) *\] */,'\1 ]')
text.gsub!(/\] *;/,'] ;')
text.gsub!(/\[\s*?([0-9]+?)\s*\]/,'[\1]')

# parentheses
text.gsub!(/(\S) *\( */,'\1 ( ')
text.gsub!(/(\S) *\) */,'\1 ) ')

# operators
text.gsub!(/ *&amp; */,' &amp; ')
text.gsub!(/\t *&amp; */,"\t&amp; ")
#text.gsub!(/ *([≤≥&lt;&gt;+=≠\-]+) */,' \1 ')

# remove trailing spaces
text.gsub!(/[ \t]+(\n)/,'\1')

# convert to hard tabs

print text</string>
	<key>input</key>
	<string>selection</string>
	<key>keyEquivalent</key>
	<string>^H</string>
	<key>name</key>
	<string>Tidy*</string>
	<key>output</key>
	<string>replaceSelectedText</string>
	<key>scope</key>
	<string>source.filemaker</string>
	<key>uuid</key>
	<string>FA742894-F5C0-4E13-BC0E-F1D38416E084</string>
</dict>
</plist>
